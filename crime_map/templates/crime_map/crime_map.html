<!DOCTYPE html>
<html>
<head>
    <title>범죄 데이터 시각화</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body, html { height: 100%; margin: 0; padding: 0; }
        #map { height: 100%; width: 100%; }
        .search-container, .dropdown-container {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border-radius: 5px;
            z-index: 1000;
        }
        .dropdown-container {
            top: 60px;
        }
        .search-container input, .dropdown-container select {
            width: 200px;
            padding: 5px;
            margin-right: 5px;
        }
        .button-container {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border-radius: 5px;
            z-index: 1000;
        }
        .button-container button {
            display: block;
            margin: 5px 0;
            padding: 10px 15px;
            border: none;
            background: #007BFF;
            color: white;
            cursor: pointer;
            border-radius: 5px;
        }
        .button-container button.active {
            background: #0056b3;
        }
        .status {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: white;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border-radius: 5px;
            z-index: 1000;
        }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB0BRDyw2bHgp1uwNb4uFjvakhL8IKGS2k&libraries=places,visualization"></script> 
</head>
<body>
    <div class="search-container">
        <input id="search-input" type="text" placeholder="Search for a place">
        <button onclick="searchPlace()">Search</button>
    </div>
    <div class="dropdown-container">
        <select id="year-select" onchange="updateDropdown()">
            <!-- Options will be populated by JavaScript -->
        </select>
        <select id="police-station-select" onchange="updateDropdown()">
            <!-- Options will be populated by JavaScript -->
        </select>
    </div>
    <div class="button-container">
        <button id="btn-폭력" onclick="filterCrime('폭력')">폭력</button>
        <button id="btn-성폭행" onclick="filterCrime('성폭행')">성폭행</button>
        <button id="btn-절도" onclick="filterCrime('절도')">절도</button>
        <button id="btn-살인" onclick="filterCrime('살인')">살인</button>
        <button id="btn-강도" onclick="filterCrime('강도')">강도</button>
    </div>
    <div id="map"></div>
    <div id="status" class="status">Select a crime type</div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        var map;
        var circles = [];
        var activeCrimeType = null;
        var crimeColors = {
            '폭력': '#FF0000',    // 빨간색
            '성폭행': '#00FF00',  // 초록색
            '절도': '#0000FF',    // 파란색
            '살인': '#FFFF00',    // 노란색
            '강도': '#FF00FF'     // 자홍색
        };
    
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 35.1796, lng: 129.0756 }, // 부산 중심 좌표
                zoom: 12
            });
    
            map.data.loadGeoJson('/static/geojson/busan_districts.geojson');
            map.data.setStyle(function(feature) {
                return {
                    fillColor: '#CCCCCC',
                    fillOpacity: 0.5,
                    strokeColor: 'grey',
                    strokeWeight: 1
                };
            });
            populateDropdowns();
        }
    
        function populateDropdowns() {
            var years = [2018, 2019, 2020, 2021, 2022, 2023];
            var policeStations = [
                '중부', '동래', '영도', '동부', '부산진', '서부', 
                '남부', '해운대', '사상', '금정', '사하', 
                '연제', '강서', '북부', '기장'
            ];
    
            var yearSelect = document.getElementById('year-select');
            var policeStationSelect = document.getElementById('police-station-select');
    
            years.forEach(function(year) {
                var option = document.createElement('option');
                option.value = year;
                option.text = year;
                yearSelect.appendChild(option);
            });
    
            policeStations.forEach(function(station) {
                var option = document.createElement('option');
                option.value = station;
                option.text = station;
                policeStationSelect.appendChild(option);
            });
        }
    
        function updateDropdown() {
            var year = document.getElementById('year-select').value;
            var station = document.getElementById('police-station-select').value;
            if (activeCrimeType && year && station) {
                getCrimeDetails(activeCrimeType, year, station);
            }
        }
    
        function getCrimeDetails(crimeType, year, station) {
            $.getJSON(`/crime_data/${crimeType}/${year}/${station}`, function(data) {
                var position = data.position;
                var count = data.count;
                var content = `<b>연도:</b> ${year}<br><b>경찰서:</b> ${station}<br><b>범죄 유형:</b> ${crimeType}<br><b>발생 횟수:</b> ${count}`;
                
                if (searchMarker) {
                    searchMarker.setMap(null);
                }
    
                searchMarker = new google.maps.Marker({
                    map: map,
                    position: position,
                    title: `${year} ${station} ${crimeType}`
                });
    
                var infowindow = new google.maps.InfoWindow({
                    content: content
                });
    
                searchMarker.addListener('click', function() {
                    infowindow.open(map, searchMarker);
                });
    
                infowindow.open(map, searchMarker);
            });
        }
    
        function updateMap(crimeType) {
    var year = document.getElementById('year-select').value;
    var station = document.getElementById('police-station-select').value;

    $.getJSON(`/crime_map/crime_data/${crimeType}`, function(crimeData) {
        circles.forEach(function(circle) {
            circle.setMap(null);
        });
        circles = [];

        var maxCount = Math.max(...crimeData.map(crime => crime.count));
        var color = crimeColors[crimeType];

        crimeData.forEach(function(crime) {
            var intensity = crime.count / maxCount;
            var fillColor = adjustColorIntensity(color, intensity);
            var radius = Math.sqrt(crime.count) * 100; // 반경 조정

            var circle = new google.maps.Circle({
                strokeColor: fillColor,
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: fillColor,
                fillOpacity: 0.35,
                map: map,
                center: { lat: crime.lat, lng: crime.lng },
                radius: radius
            });

            circle.addListener('click', function() {
                var showDetails = confirm("상세 정보를 보시겠습니까?");
                if (showDetails) {
                    var content = `<b>범죄 유형:</b> ${crimeType}<br><b>발생 횟수:</b> ${crime.count}<br><b>위치:</b> (${crime.lat}, ${crime.lng})`;
                    var infowindow = new google.maps.InfoWindow({
                        content: content
                    });
                    infowindow.setPosition(circle.getCenter());
                    infowindow.open(map);
                }
            });

            circles.push(circle);
        });

        map.data.setStyle(function(feature) {
            var district = feature.getProperty('name');
            var count = 0;
            for (var i = 0; i < crimeData.length; i++) {
                if (crimeData[i].district === district) {
                    count += crimeData[i].count;
                }
            }
            var intensity = count / maxCount;
            var fillColor = adjustColorIntensity(color, intensity);
            return {
                fillColor: count > 0 ? fillColor : '#CCCCCC', // 기본 회색 색상
                fillOpacity: count > 0 ? 0.5 : 0.5, // 불투명도 유지
                strokeColor: 'grey',
                strokeWeight: 1
            };
        });

        document.getElementById('status').innerText = crimeType + ' 필터가 적용 중 입니다';
    }).fail(function() {
        alert("데이터를 가져오는데 실패했습니다.");
    });
}

    function filterCrime(crimeType) {
        var button = document.getElementById('btn-' + crimeType);
        if (activeCrimeType === crimeType) {
            resetMap();
            activeCrimeType = null;
            document.getElementById('status').innerText = 'Select a crime type';
            button.classList.remove('active');
            button.style.backgroundColor = '#007BFF';
        } else {
            updateMap(crimeType);
            if (activeCrimeType) {
                var activeButton = document.getElementById('btn-' + activeCrimeType);
                activeButton.classList.remove('active');
                activeButton.style.backgroundColor = '#007BFF';
            }
            activeCrimeType = crimeType;
            button.classList.add('active');
            button.style.backgroundColor = crimeColors[crimeType];
        }
    }

    function resetMap() {
        map.data.setStyle(function(feature) {
            return {
                fillColor: '#CCCCCC',
                fillOpacity: 0.5,
                strokeColor: 'grey',
                strokeWeight: 1
            };
        });
        circles.forEach(function(circle) {
            circle.setMap(null);
        });
        circles = [];
        if (searchMarker) {
            searchMarker.setMap(null);
        }
    }

    function adjustColorIntensity(color, intensity) {
        var hex = color.replace('#', '');
        var r = parseInt(hex.substring(0, 2), 16);
        var g = parseInt(hex.substring(2, 4), 16);
        var b = parseInt(hex.substring(4, 6), 16);

        r = Math.floor(r * intensity);
        g = Math.floor(g * intensity);
        b = Math.floor(b * intensity);

        return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
    }

    function searchPlace() {
        var input = document.getElementById('search-input').value;
        var geocoder = new google.maps.Geocoder();

        geocoder.geocode({ address: input }, function(results, status) {
            if (status === 'OK') {
                map.setCenter(results[0].geometry.location);
                map.setZoom(14);

                if (searchMarker) {
                    searchMarker.setMap(null);
                }

                searchMarker = new google.maps.Marker({
                    map: map,
                    position: results[0].geometry.location,
                    title: input
                });
            } else {
                alert('Geocode was not successful for the following reason: ' + status);
            }
        });
    }

    window.onload = initMap;
</script>